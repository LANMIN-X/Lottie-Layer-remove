
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Lottie 图层删除（多选版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .preview-container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }
        .preview-box {
            width: 100%;
            height: 300px;
            background: #f5f5f5;
            margin-bottom: 10px;
        }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            vertical-align: top;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #uploadInput {
            display: none;
        }
        .status {
            margin-top: 10px;
            color: #666;
        }
        .input-group {
            margin: 10px 0;
            display: inline-block;
            vertical-align: top;
        }
        .input-group label {
            margin-right: 10px;
            display: block;
            margin-bottom: 5px;
        }
        .input-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 250px;
            height: 150px; /* 让多选框有足够的高度 */
            background-color: white;
        }
        .input-group select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Lottie 图层删除（可多选，仅用于学习）</h1>
    
    <div class="controls">
        <input type="file" id="uploadInput" accept=".json">
        <button id="uploadBtn">上传 JSON 文件</button>
        <div class="input-group">
            <label for="layerSelect">选择要删除的图层 (按住 Ctrl/Cmd 可多选):</label>
            <select id="layerSelect" disabled multiple>
                <option value="" disabled>请先上传文件</option>
            </select>
        </div>
        <button id="processBtn" disabled>处理文件</button>
        <button id="downloadBtn" disabled>下载处理后的文件</button>
        <button id="downloadMinBtn" disabled>下载压缩版文件</button>
        <div class="status" id="status"></div>
    </div>

    <div class="container">
        <div class="preview-container">
            <h3>原始动画 (高亮预览)</h3>
            <div id="originalPreview" class="preview-box"></div>
        </div>
        <div class="preview-container">
            <h3>处理后动画</h3>
            <div id="processedPreview" class="preview-box"></div>
        </div>
    </div>

    <script>
        let originalData = null;
        let processedData = null;
        let originalAnimation = null;
        let processedAnimation = null;

        // 获取图层列表的函数
        function getLayers(lottieData) {
            const layers = [];
            if (lottieData && lottieData.layers) {
                lottieData.layers.forEach(layer => {
                    if (layer.nm) { // 确保图层有名称
                        layers.push({
                            name: layer.nm,
                            id: layer.ind
                        });
                    }
                });
            }
            return layers;
        }

        // 高亮显示选中的图层 (通过调暗其他图层)
        function highlightLayer(selectedLayerNames) {
            if (!originalData) return;
            
            if (originalAnimation) {
                originalAnimation.destroy();
            }

            // 如果没有选择图层，或选择数组为空，则显示原始动画
            if (!selectedLayerNames || selectedLayerNames.length === 0) {
                originalAnimation = initPreview(document.getElementById('originalPreview'), originalData);
                return;
            }

            const highlightData = JSON.parse(JSON.stringify(originalData));
            const selectedNamesSet = new Set(selectedLayerNames);

            highlightData.layers.forEach(layer => {
                // 如果图层未被选中，则将其透明度设为30%
                if (!selectedNamesSet.has(layer.nm)) {
                    if (!layer.ks) layer.ks = {};
                    // 通过覆盖透明度属性来实现“调暗”，这是最简单可靠的方法
                    layer.ks.o = { a: 0, k: 30 }; // a:0 表示非动画, k:30 表示值为30
                }
            });

            originalAnimation = initPreview(document.getElementById('originalPreview'), highlightData);
        }

        // 删除指定的多个 Lottie 图层及其所有子图层
        function removeLottieLayers(lottieData, targetLayerNames) {
            const data = JSON.parse(JSON.stringify(lottieData));
            const targetNamesSet = new Set(targetLayerNames);
            const idsToRemove = new Set();
            
            // 构建父-子关系图，并找到初始要删除的图层ID
            const parentToChildren = {};
            data.layers.forEach(layer => {
                if (targetNamesSet.has(layer.nm)) {
                    idsToRemove.add(layer.ind);
                }
                if (layer.parent) {
                    if (!parentToChildren[layer.parent]) {
                        parentToChildren[layer.parent] = [];
                    }
                    parentToChildren[layer.parent].push(layer);
                }
            });

            // 使用队列广度优先搜索，找到所有子孙图层的ID
            const queue = [...idsToRemove];
            const visited = new Set(queue); // 避免重复处理

            while (queue.length > 0) {
                const parentId = queue.shift();
                const children = parentToChildren[parentId] || [];
                children.forEach(child => {
                    if (!visited.has(child.ind)) {
                        idsToRemove.add(child.ind);
                        visited.add(child.ind);
                        queue.push(child.ind);
                    }
                });
            }

            // 过滤掉所有需要删除的图层
            data.layers = data.layers.filter(layer => !idsToRemove.has(layer.ind));
            return data;
        }

        // 初始化动画预览
        function initPreview(container, data) {
            // 清空容器内容，防止多个 SVG 叠加
            container.innerHTML = '';
            return lottie.loadAnimation({
                container: container,
                renderer: 'svg',
                loop: true,
                autoplay: true,
                animationData: data
            });
        }
        
        // 获取多选框中的所有选中值
        function getSelectedValues(selectElement) {
            return Array.from(selectElement.selectedOptions).map(option => option.value);
        }

        // --- 事件监听器 ---

        document.getElementById('uploadBtn').addEventListener('click', () => {
            document.getElementById('uploadInput').click();
        });

        document.getElementById('uploadInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    originalData = JSON.parse(event.target.result);
                    
                    // 清除之前的预览
                    if (originalAnimation) originalAnimation.destroy();
                    if (processedAnimation) processedAnimation.destroy();
                    document.getElementById('processedPreview').innerHTML = '';
                    
                    // 显示原始动画
                    originalAnimation = initPreview(document.getElementById('originalPreview'), originalData);

                    // 更新图层选择下拉框
                    const layerSelect = document.getElementById('layerSelect');
                    layerSelect.innerHTML = ''; // 清除现有选项
                    
                    const layers = getLayers(originalData);
                    if (layers.length === 0) {
                       const option = document.createElement('option');
                       option.text = '未找到带名称的图层';
                       option.disabled = true;
                       layerSelect.appendChild(option);
                       document.getElementById('processBtn').disabled = true;
                    } else {
                       layers.forEach(layer => {
                           const option = document.createElement('option');
                           option.value = layer.name;
                           option.text = `${layer.name} (ID: ${layer.id})`;
                           layerSelect.appendChild(option);
                       });
                       // 启用选择框和处理按钮
                       layerSelect.disabled = false;
                       document.getElementById('processBtn').disabled = false;
                    }
                    
                    document.getElementById('status').textContent = '文件已加载，请选择要删除的图层。';
                    document.getElementById('downloadBtn').disabled = true;
                    document.getElementById('downloadMinBtn').disabled = true;

                } catch (error) {
                    document.getElementById('status').textContent = '文件加载失败：无效的 JSON 文件。';
                    console.error(error);
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('layerSelect').addEventListener('change', (e) => {
            const selectedNames = getSelectedValues(e.target);
            highlightLayer(selectedNames);

            if (selectedNames.length > 0) {
                document.getElementById('status').textContent = `已选择 ${selectedNames.length} 个图层。`;
            } else {
                document.getElementById('status').textContent = '请选择要删除的图层。';
            }
        });

        document.getElementById('processBtn').addEventListener('click', () => {
            const layerSelect = document.getElementById('layerSelect');
            const selectedNames = getSelectedValues(layerSelect);
            
            if (!originalData || selectedNames.length === 0) {
                document.getElementById('status')。textContent = '错误：请至少选择一个要删除的图层。';
                return;
            }

            try {
                processedData = removeLottieLayers(originalData， selectedNames);
                
                if (processedAnimation) {
                    processedAnimation。destroy();
                }
                
                // 显示处理后的动画
                processedAnimation = initPreview(
                    document。getElementById('processedPreview')，
                    processedData
                );

                // 恢复原始预览区为完整动画
                highlightLayer([]);

                document。getElementById('downloadBtn')。disabled = false;
                document。getElementById('downloadMinBtn')。disabled = false;
                document。getElementById('status')。textContent = `处理完成，已成功删除 ${selectedNames.length} 个图层及其子图层。`;

            } catch (error) {
                document.getElementById('status').textContent = '处理失败: ' + error.message;
                console。error(error);
            }
        });

        document。getElementById('downloadBtn')。addEventListener('click', () => {
            if (!processedData) return;
            const blob = new Blob([JSON.stringify(processedData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'processed-animation.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('downloadMinBtn').addEventListener('click', () => {
            if (!processedData) return;
            const minifiedData = JSON.stringify(processedData);
            const blob = new Blob([minifiedData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'processed-animation.min.json';
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
